---
title: 并发可视化工具中的线程视图 | Microsoft Docs
ms.date: 11/04/2018
ms.topic: conceptual
f1_keywords:
- vs.performance.view.threadblocking
helpviewer_keywords:
- Concurrency Visualizer, Threads View (Parallel Performance)
ms.assetid: 2e441103-a266-407b-88c3-fb58716257a3
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 4382a21a68848a758f3d4cd37a8528722927691c
ms.sourcegitcommit: 94b3a052fb1229c7e7f8804b09c1d403385c7630
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/23/2019
ms.locfileid: "62973744"
---
# <a name="threads-view-in-the-concurrency-visualizer"></a>并发可视化工具中的线程视图

“线程”视图在并发可视化工具中最详细且功能最丰富的视图。 在“线程”视图中，可识别在执行段期间执行代码的线程，并分析线程是否正在执行或由于同步、I/O 或其他原因而阻塞。 “线程”视图报告还分析调用堆栈树的执行和取消阻塞线程。

当线程正在执行时，并发可视化工具会收集样本。 线程停止执行后，可视化工具将检查所有操作系统上下文切换事件的线程。 发生上下文切换的原因：

- 线程在同步基元上受阻。
- 线程的量程到期。
- 线程进行了阻塞 I/O 请求。

并发可视化工具对线程和上下文切换事件分类，并在线程的调用堆栈中搜索已知阻塞 API。 它在“线程”视图的左下角的活动图例中显示线程类别。 在大多数情况下，可以通过检查与上下文切换事件对应的调用堆栈来确定阻塞事件的根本原因。

如果没有调用堆栈匹配，则并发可视化工具使用 [!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] 提供的“等待”原因。 但是，[!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] 类别可能基于实现详细信息，并且可能无法反映用户意图。 例如，[!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] 会将在本机精简读取器/编写器锁上阻塞的等待原因报告为 I/O 而不是同步。

“线程”视图还显示线程之间的依赖关系。 例如，如果发现在同步对象上阻塞的线程，则可找到对其取消阻塞的线程。 可以检查调用堆栈中的取消阻塞线程（当该线程取消阻塞另一个线程时）。

可使用“线程”视图执行以下操作：

- 确定应用的用户界面 (UI) 在特定执行阶段中无响应的原因。
- 确定在同步、I/O、页面错误和其他事件上阻塞所花的时间量。
- 发现来自系统上执行的其他进程的干扰的程度。
- 确定并行执行的负载平衡问题。
- 找出可伸缩性未达到最优或可伸缩性不存在的原因。 例如，为什么可使用更多逻辑核心时，并行应用的性能不提高。
- 了解应用中的并发度以帮助进行并行化。
- 确定工作线程和执行的关键路径间的依赖关系。

## <a name="use-threads-view"></a>使用“线程”视图

要启动并发可视化工具，请选择“分析” > “并发可视化工具”，然后选择一个选项，例如“启动新进程”。

并发可视化工具会启动应用并收集跟踪，直到用户选择“停止收集”。 然后，可视化工具会分析跟踪并在跟踪报告页面上显示结果。

选择报告左上角的“线程”选项卡，打开“线程”视图。

![“线程”视图](../profiling/media/threadsviewnarrowing.png "“线程”视图")

选择时间间隔和线程，开始性能分析。

## <a name="timeline-analysis"></a>时间线分析

“线程”视图的上半部分是时间线。 时间线显示主计算机上的进程与所有物理磁盘设备中的所有线程的活动。 它还显示 GPU 活动和标记事件。

在时间线上，X 轴上是时间，y 轴上是几个通道：

- 系统上每个磁盘驱动器两个 I/O 通道，一个通道用于读取，另一个用于写入。
- 进程中每个线程一个通道。
- 标记通道（如果跟踪中存在事件标记）。 标记通道最初出现在生成这些事件的线程通道下。
- GPU 通道。

最初，线程按创建顺序进行排序，以便主应用线程处于第一位。 在“排序依据”下拉列表中选择另一个选项，以按另一种标准（例如“执行”）对线程进行排序。

时间线的颜色指示线程在给定时间的状态。 绿色段表示已在执行，红色段指示已因同步而受阻，黄色段指示已被抢占，紫色段指示已参与设备 I/O。

可以放大以查看更多详细信息，也可以缩小以查看更长的时间间隔。 在图上选择段和点以获取有关类别、开始时间、延迟和调用堆栈状态的详细信息。

使用该时间线检查并行循环和并发任务所涉及的线程间的工作平衡。 如果某个线程完成所用时间要长于其他线程，则工作可能会不平衡。 可提高应用的性能，具体方法是在线程间更均匀地分布工作。

如果在某个时间点只有一个线程正在执行，则应用可能无法在系统上充分利用并发。 可以使用时间线关系图检查线程之间的依赖关系以及阻塞线程与被阻塞线程之间的临时关系。 若要重新排列线程，请选择一个线程，然后在工具栏上选择向上或向下按钮。

可隐藏未执行工作或完全受阻的线程，因为其统计信息不相关，可能会阻碍报告。 可隐藏线程，方法是选择线程名称，然后选择工具栏上的“隐藏所选线程”或“隐藏所选线程之外的所有线程”图标。 要识别要隐藏的线程，请选择左下角的“每线程摘要”链接。 可隐藏“每线程摘要”图中非活动状态的线程。

### <a name="thread-execution-details"></a>线程执行详细信息
要获取有关执行段的更多详细信息，请选择时间线绿色段上的点。 可视化工具在所选点上方显示黑色脱字号，并在底部窗格的“当前”选项卡上显示其调用堆栈。 可以在执行段上选择多个点。

>[!NOTE]
>若段的持续时间少于 1 毫秒，则并发可视化工具可能无法解析执行段上的选择。

若要获取当前所选时间范围内所有未隐藏线程的执行分析，请在左下方的图例中选择“执行”。

### <a name="thread-blocking-details"></a>线程阻塞详细信息
要获取有关线程上特定区域的信息，请将鼠标悬停在时间线上该区域的上方以显示工具提示。 工具提示包含类别、开始时间和延迟等信息。 选择区域以在底部窗格的“当前”选项卡中显示该时间点的调用堆栈。 该窗格还显示类别、延迟、阻塞 API（如果存在），以及取消阻塞线程（如果存在）。 通过检查调用堆栈，可以确定线程阻塞事件的基本原因。

执行路径可能有多个阻塞事件。 要通过阻塞类别进行检查并更快找到问题区域，请在左侧的图例中选择阻塞类别。

### <a name="dependencies-between-threads"></a>线程之间的依赖关系
并发可视化工具显示线程之间的依赖关系，以便用户确定受阻线程尝试执行的操作，以及其他线程使它可以执行的操作。

若要确定哪个线程对另一个线程取消了阻塞，请选择时间线上的阻塞段。 如果并发可视化工具可以确定取消阻塞线程，则它会在取消阻塞线程与跟在阻塞段之后的执行段之间绘制一条线。 在底部窗格中选择“取消阻塞堆栈”可以查看相关调用堆栈。

## <a name="profile-reports"></a>分析报告
时间线图下方是一个窗格，其中包含“分析报告”、“当前”和“取消阻塞堆叠”报告选项卡。 更改时间线和线程选择时，报告会自动更新。 对于大型跟踪，在计算更新时，报告窗格可能暂时不可用。

### <a name="profile-report-tab"></a>“分析报告”选项卡

“分析报告”具有两个筛选器：

- 要筛选掉花费很少时间的调用树条目，请在“降噪目标”字段中键入介于 0 和 99% 之间的筛选值。 默认值为 2%。
- 若要仅查看你的代码的调用树，请选中“仅我的代码”复选框。 若要查看所有调用树，请清除该复选框。

“分析报告”选项卡在图例中显示类别和链接的报告。 要显示报告，请选择左侧的其中一个条目：

- **执行**“执行”报表显示应用程序在执行过程所用的时间的明细。

  若要查找在其中花费执行时间的代码行，请展开调用关系树，然后在调用树条目快捷菜单上，选择“查看源”或“查看调用站点”。 “查看源”会查找执行的代码行。 “查看调用站点”会查找调用执行的代码行。 如果只有一个调用站点行存在，则会突出显示其代码。 如果存在多个调用站点，请在对话框中选择所需的调用站点，然后选择“转至源”。 在查找具有最多实例和/或最大时间的调用站点时，这往往最为有用。 有关详细信息，请参阅[执行分析报告](../profiling/execution-profile-report.md)。

- **同步**“同步”报表显示对同步块负责的调用，以及每个调用堆栈的总阻塞时间。 有关详细信息，请参阅[同步时间](../profiling/synchronization-time.md)。

- **I/O**“I/O”报表显示对 I/O 块负责的调用，以及每个调用堆栈的总阻塞时间。 有关详细信息，请参阅 [I/O 时间（线程视图）](../profiling/i-o-time-threads-view.md)。

- **休眠**“休眠”报表显示对休眠块负责的调用，以及每个调用堆栈的总阻塞时间。 有关详细信息，请参阅[睡眠时间](../profiling/sleep-time.md)。

- **内存管理**“内存管理”报表显示出现内存管理块的调用，以及每个调用堆栈的总阻塞时间。 使用此信息可以确定具有过多分页或垃圾回收问题的区域。  有关详细信息，请参阅[内存管理时间](../profiling/memory-management-time.md)。

- **抢占**“抢占”报表显示其中的系统上进程抢占当前进程以及替换了当前进程中的线程的各个线程。 可以使用此信息确定对抢占负有最多责任的进程和线程。 有关详细信息，请参阅[抢占时间](../profiling/preemption-time.md)。

- **UI 处理**“UI 处理”报表显示对 UI 处理块负责的调用，以及每个调用堆栈的总阻塞时间。 有关详细信息，请参阅 [UI 处理时间](../profiling/ui-processing-time.md)。

- **每线程摘要** 选择“每线程摘要”会显示一个图表，该图表显示当前所选时间间隔的线程状态。 此彩色编码列显示每个线程在运行、阻塞、I/O 和其他状态下所用的总时间。 线程在底部进行标记。 调整时间线关系图中的缩放级别时，此图会自动更新。

  在某些缩放级别，某些线程可能不会在图中显示。 发生这种情况时，省略号 (**...**) 会出现在右侧。 如果所需线程未出现，则可以隐藏其他线程。 有关详细信息，请参阅[“每线程摘要”报告](../profiling/per-thread-summary-report.md)。

- **Disk 操作** 选择“Disk 操作”，可显示当前进程的磁盘 I/O 中涉及的进程和线程、它们使用的文件（例如，已加载的 DLL）、读取的字节数以及其他信息。 可以使用此报告评估在执行过程中用于访问文件的时间（尤其是在进程似乎受到 I/O 限制时）。 有关详细信息，请参阅[“磁盘操作”报告](../profiling/disk-operations-report-threads-view.md)。

### <a name="current-tab"></a>“当前”选项卡
此选项卡显示时间线关系图中某个线程段上的所选点的调用堆栈。 调用堆栈会进行修整以显示与应用相关的活动。

### <a name="unblocking-stack-tab"></a>“取消阻塞堆栈”选项卡
此选项卡显示取消阻塞所选线程的线程以及取消阻塞调用堆栈。

## <a name="see-also"></a>请参阅
- [并发可视化工具](../profiling/concurrency-visualizer.md)
